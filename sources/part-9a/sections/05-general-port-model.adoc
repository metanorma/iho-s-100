[[cls-9a-5]]
== General Portrayal Model

There are no changes to the <<Part9>> general portrayal model. A Lua portrayal follows the
general portrayal model described in <<Part9,clause="9-5">>. <<fig-9a-1>> illustrates the general
portrayal model.

[[fig-9a-1]]
.General portrayal model
image::img126.png[]

[[cls-9a-5.1]]
=== The Portrayal Process

As illustrated in <<fig-9a-2>>, a Lua portrayal requires the following changes to the
portrayal process described in <<Part9,clause="9-5.1">> and captured in <<tab-9a-1>>:

[[tab-9a-1]]
.Changes to the portrayal process
[cols=2,options=header]
|===
| Part 9 | Part 9a

| Portrayal functions are written in the XSLT programming language. | Portrayal functions are written in the Lua programming language.
| Host provides an XSLT implementation. | Host provides a Lua interpreter or Lua virtual machine.
| Feature data is exposed to the portrayal functions via an XML document which must describe all features to be portrayed, along with all attribution, spatial relations, information associations, and all other information which may be used by the portrayal functions. | Feature data is not initially exposed to the portrayal functions. Instead, the host provides a list of the feature IDs to be portrayed; the portrayal functions will request attribution, spatial relations, information associations, and all other information as needed via host call-back functions.
| Drawing instructions are returned to the host as an XML document, which is the result of an XSL transformation applied to the input feature data. | Drawing instructions are returned to the host via host call-back function _HostPortrayalEmit_.
|===

[[fig-9a-2]]
.Portrayal process
image::img127.png[]

[[cls-9a-5.2]]
=== LuaPortrayal Process

This section describes the Part 9a portrayal process in detail, and indicates where
there are changes to <<Part9>>. The Lua portrayal process is shown in <<fig-9a-3>>.

[[fig-9a-3]]
.Lua Portrayal Process
image::img128.png[]

[[cls-9a-5.2.1]]
==== Portrayal Initialization

Prior to calling Lua portrayal functions, the host must register the domain specific
scripting catalogue functions by loading a portrayal catalogue _TopLevelTemplate_ rule
file (a Lua script file). In order to prevent name collisions on __PortrayalMain__, the
host must instantiate and initialize a new Lua runtime environment each time the
_TopLevelTemplate_ is changed. Alternatively, the host can maintain multiple Lua
runtimes, one for each _TopLevelTemplate_.

After registering the scripting catalogue functions, the host calls

_PortrayalInitializeContextParameters_, passing in the name and default value for
each portrayal context parameter defined by the portrayal catalogue. The portrayal
context parameter values are associated with the given dataset and stay in effect until
the scripting session is closed, or the values are changed via
_PortrayalSetContextParameter_.

[[cls-9a-5.2.2]]
==== Generating a Portrayal

Portrayal script function _PortrayalMain_ (see <<cls-9a-14.1.1>>) is used to generate
drawing instructions for a set of feature instances. The host passes in a set of
feature IDs to _PortrayalMain_; the portrayal scripts will iterate over the feature
IDs and generate drawing instructions for each.

As each feature instance is processed, the portrayal engine will call standard host
functions to request attribute, spatial, or other information as needed. Upon
completion of processing for a feature instance the portrayal engine will call
_HostPortrayalEmit_ (see <<cls-9a-14.2.1>>) and provide the drawing instructions for
that feature instance to the host application.

The portrayal for a given _S100_Dataset_ is complete when the call to _PortrayalMain_
returns. If the portrayal completed successfully, _PortrayalMain_ returns true,
otherwise _PortrayalMain_ returns false along with a message indicating why the
portrayal did not run to completion.

A host can terminate a portrayal prior to processing all feature instances by returning
false from _HostPortrayalEmit_.

Calling _PortrayalMain_ with all feature IDs from a given dataset will generate drawing
instructions for the entire dataset. Drawing instructions for a subset of a dataset can
be (re)generated by passing in feature IDs corresponding to the subset. This is useful
when the host needs to regenerate a set of cached drawing instructions, or if the host
is portraying a subset of a dataset such as a single _S100_DataCoverage_.

[[cls-9a-5.2.2.1]]
===== Implementing a Portrayal Cache

In order to speed up the rendering process the host can optionally implement a
portrayal cache. A portrayal cache is used to cache the drawing instructions which are
output from the portrayal. Caching the drawing instructions for each feature instance
allows the host to re-render feature instances without re-generating their portrayal. A
cached drawing instruction only needs to be re-generated when one or more context
parameters which were used to generate the drawing instruction changes.

When the portrayal scripts return the drawing instructions for a feature instance they
also return a list of "observed" portrayal context parameters (see <<cls-9a-14.2.1>>).
The observed context parameters are those context parameters which were evaluated
during the generation of drawing instructions for a particular feature. For more detail
on context parameters refer to <<Part9,clause="9-13.3.22">>.

A notional portrayal cache is shown in <<fig-9a-4>>. To implement, the host should
cache the value of observed context parameters along with the generated drawing
instructions and associate both with the feature instance. Note that a feature instance
may have any number of observed context parameters, including zero.

Any changes to a context parameter requires that the host regenerate the drawing
instructions for all feature instances with a matching observed context parameter.
Alternatively, the host may use cached drawing instructions which were previously
generated for the new value of the changed context parameter(s). Features which have no
observed parameters can persist in the cache until a new portrayal catalogue is issued.

[[fig-9a-4]]
.Notional Portrayal Cache
image::img129.png[]

[[cls-9a-5.2.2.2]]
===== Pre-processing a Portrayal

Implementing a portrayal cache allows the host to pre-generate the drawing instructions
for a given set or sets of context parameters. This would typically be implemented as
part of the hosts data import functionality.
