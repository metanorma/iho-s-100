[[cls-9-11]]
== Drawing Instructions

[[cls-9-11.1]]
=== The concepts of drawing instructions

[[cls-9-11.1.1]]
==== General concept

The output of the portrayal engine is a set of drawing instructions, which link the feature type to a symbol and/or alert reference. The geometry is either taken from the feature type or can be generated by the portrayal functions. The latter is supported by the concept of augmented geometry.

[[cls-9.11.1.2]]
==== Portrayal Coordinate Reference Systems (CRS)

In this context coordinate reference systems refer to the portrayal geometry only.

There are different CRS related to the portrayal:

* Geographic CRS
* Portrayal CRS
* Local CRS
* Line CRS
* Area CRS
* Tile CRS
* Hatch CRS

Geographic CRS are used in the geographic dataset that are portrayed. They will be mapped by means of projections and affine transformation to the Portrayal CRS. Nevertheless rotations of symbols may be still defined relative to the North-Axis of the Geographic CRS.

The Portrayal CRS defines the coordinates at the output device, for example a screen or pixmap.

Line symbols have two kinds of coordinate reference systems. The line coordinate reference system is a non-Cartesian 2-axis coordinate system. The stem:[x]-axis is following the line geometry and the stem:[y]-axis is perpendicular to the geometry of the curve. This CRS allows for the specification of line widths,offsets and symbols following the geometry. The second kind of coordinate reference system is a local Cartesian coordinate reference system which is defined for every location along a curve. This coordinate reference system has an stem:[x]-axis that is tangential to the curve and a stem:[y]-axis perpendicular to the stem:[x]-axis.

An area symbol defines coordinate reference systems for its boundary and for its interior. The boundary coordinate reference systems are those defined for line symbols. The interior of the area symbol has its own coordinate reference system.

For tiled pattern and hatch patterns own CRS are defined.

[[cls-9-11.1.3]]
==== Viewing Groups, Viewing Group Layers and Display Mode

The viewing group is a concept to control the content of the display. It works as an on/off switch for any drawing instruction assigned to the corresponding viewing group. The concept can be seen as a filter on the list of drawing instructions.

A drawing instruction which has multiple Viewing Groups is disabled when any assigned Viewing Group is disabled.

Viewing groups can be aggregated into Viewing Group Layers and Viewing Group Layers can be aggregated into Display Modes. Both aggregations are part of the Portrayal Catalogue.

[[cls-9-11.1.4]]
==== Transparency

Additive effects of applying transparencies shall be accomplished by multiplying the component alpha values. For example, a colour token which has transparency of 10% which is drawn with a transparency of 20% shall result in stem:[(1 - 10%) * (1 - 20%) = 72% " alpha" = 28%] transparency.

[[cls-9-11.1.5]]
==== Display Planes

Display planes are a concept to split the output of the portrayal functions into separate lists. An example of this is the separation of chart information drawn under a radar image and chart information drawn over a radar image.

[[cls-9-11.1.6]]
==== Display Priorities

Display priorities control the order in which the output of the portrayal functions is processed by the rendering engine. Priorities with smaller numerical values will be processed first. Instructions which have equal display priority must be ordered so that area instructions are rendered first, followed by line instructions, then point instructions, and lastly text instructions. If the display priority is equal among the same type of instruction (area, line, point, or text) some other neutral criterion must be used to order the instructions.

[[cls-9-11.1.7]]
==== Null Instruction

This is an instruction to indicate that a feature is intentionally not portrayed.

[[cls-9-11.1.8]]
==== Point Instruction

===== Overview

The Point Instruction defines the drawing of a symbol. The symbol can be parameterized. This includes rotation, scaling and offset. The details are described in the documentation of the Symbol package.

===== Point Geometry

When the Point Instruction references point geometry the symbol is drawn using its position.

===== MultiPoint Geometry

The symbol is repeated using each position of the Multi Point.

===== Curve Geometry

The symbol is drawn on each referenced curved from either the spatialReference or if this is not used on each curve directly referenced by the feature type. The placement of the symbol is controlled by the linePlacement element of the symbol. The details are described in the documentation of the Symbol package.

===== Surface Geometry

The symbol is drawn at a representative position within the surface. How this position is obtained is controlled by the areaPlacement member of the symbol. The details are described in the documentation of the Symbol package.

[[cls-9-11.1.9]]
==== Line Instruction

===== Overview

The Line Instruction defines the drawing of a line style. Line styles include Simple and Complex Line Styles. The line style can be parameterized. The details are described in the documentation of the LineStyles package. The geometry is defined by the referenced spatial types. Only curve or surface geometry is supported. For the latter the boundary of the surface defines the geometry. The geometry defines the direction of drawing for the line style.

===== Suppression

When features shares curve geometry multiple line instructions may reference the same curve.

If suppression is set to true (the default) another line instruction with a higher display priority will suppress the drawing of this line instruction. If suppression is set to false this instruction cannot be suppressed.

[[cls-9-11.1.10]]
==== Area Instruction

===== Overview

The Area Instruction defines the drawing of an area fill. Area Fills include Colour Fills and different Pattern Fills. The area fill can be parameterized. The details are described in the documentation of the AreaFills package. Only surface geometry is supported.

The area fill must include the boundary of the surface.

[[cls-9-11.1.11]]
==== Text Instruction

===== Overview

The Text Instruction defines the drawing of text. The text can be parameterized. This includes fonts, colour and size. The details are described in the documentation of the Text package.

===== Point Geometry

When the Text Instruction references a point geometry the text is drawn using its position. Only TextPoint elements are supported.

===== MultiPoint Geometry

The text is repeated using each position of the Multi Point. Only TextPoint elements are supported.

===== Curve Geometry

The text is repeated on each curve. Both TextPoint and TextLine elements are supported.

TextPoint is primarily intended to draw horizontal upright text placed relative to a point on the curve. TextLine is primarily intended to draw text that follows the shape of the curve.

[[tab-9-1]]
.Curve geometry -- drawing commands
[cols=3,options=header]
|===
| Drawing Command | CRS for placement | CRS for rotation
| TextPoint | LineCRS | PortrayalCRS
| TextLine | LineCRS | LineCRS
|===

[[fig-9-9]]
.Image of TextPoint used to place text at various bearings by placing the text at the end of an AugmentedRay (informative)
image::img94.png[]

More details can be found in the documentation of the text package.

===== Surface Geometry

The text is drawn at a representative position within the surface. Only TextPoint elements are supported. How this position is obtained is controlled by the areaPlacement member of the TextPoint. The details are described in the documentation of the Text package.

===== Readable Text

The display engine may adjust text to be upright and readable on screen. TextPoint defaults to horizontal on the PortrayalCRS. Rotations beyond stem:[+- 90] degrees are to be avoided. Text rendered by TextLine is meant to be upright and readable at the reference point but may turn upside down when following a curve. The bearing of the curve at the reference point will be used by the portrayal engine to make the text readable and to maintain the relative placement of the text on the curve. See the following example diagrams.

[[fig-9-10]]
.Sample of TextLine on an augmented ray with placement at end of line. Green indicates no adjustment, blue indicates adjusted placement (informative)
image::img95.png[width=50%]

[[fig-9-11]]
.Some text on curves (informative)
image::img96.png[width=50%]

===== Course Up Display

If the display engine supports a course up or non-north up display then text placements and alignments may be adjusted automatically to keep the text readable.

[[fig-9-12]]
.TextLine when display is not north up (informative)
image::img97.png[width=50%]

TextPoint placements in non-north up portrayals may also be adjusted in the display engine. The bearing and distance between the origin and the text reference point can be used to calculate the text alignment in order to retain the geographic placement and relative display distance.

===== Text Deconfliction

To avoid text overlaps and improve readability the display engine may suppress some text to make other text readable.

[[cls-9-11.1.12]]
==== Coverage Instruction

===== Overview

An instruction to portray data coverages like gridded bathymetry, satellite images, etc.

[quote,ISO,"ISO19123"]
____
A coverage is a feature that has multiple values for each attribute type, where each direct position within the geometric representation of the feature has a single value for each attribute type.
____

In this document coverage attributes used for portrayal are expected to have numeric values.

The assignment of Portrayal for a Coverage starts with a Coverage Feature. Like other Feature types a rule is used to match the Feature to Drawing instructions.

A first match lookup table is used to assign portrayal based on a specified coverage attribute. There are three options for coverage portrayal: filling with colour; annotating with numeric text; or annotating with symbols.

===== Discrete Coverages

Discrete coverages are portrayed by applying a symbol and/or numeric annotation to the direct position associated with each value of an attribute of the coverage.

===== Continuous Coverages

Continuous coverages are portrayed by filling the cells that have actual data associated, as opposed to no data (termed "fill values" in HDF5, not to be confused with colour or symbol fills as the terms are used in portrayal). The fills used in portrayal may be solid fills; patterns of symbols; pixmaps; or gradients. Fill transparency may also be specified by the applicable portrayal rule. Interpolation methods, if defined in the coverage type (see <<Part8,clause="8-7.7.3">>) may be applied to depict variations in data values in each grid cell. The anchor point for text or symbol placement is dependent on the coverage's spatial type and the placement attribute in the Portrayal Catalogue.

Irregular shape grids, ungeorectified grids, variable cell size grids (see <<Part10c,table="10c-15">>) are all treated similarly to regular grids as far as portrayal is concerned. For variable cell size grids, unit cells must be used for symbol fills (that is, in an expanded cell that covers more than one unit cell, the symbol must be depicted at the centre of each unit cell included in the expanded cell).

===== Colour Assignment

Colours are applied to a coverage by using a lookup table that matches a selected attribute value and specifies a colour. For a continuous coverage such as grid cells, pixels or tiles then each element is processed and colour filled with the appropriate colour. For a discrete coverage with distinct points colour is applied as a Pen Down or dott operation using the assigned pen width.

A lookup table entry can match a range of values and assign a single colour to that range or specify a start and end colour that is used to create a gradient or ramp effect as a linear interpolation of the value range across the colour range.

===== Numeric and Symbol Annotations

For a continuous coverage the centre of each cell (for example rectangle, tile, triangle) is used as the anchor point of the text or symbol.

For discrete coverages, the anchor point for annotations is the direct position associated with each value of the attribute designated by the attributeCode parameter of the CoverageFill (see <<cls-9-12.7.4.1>>).

For numeric annotations, overplot removal or collision avoidance is expected. A buffer can be used to provide some space between the annotations. A buffer of 0 means that direct overplot is used when digits interact. An enumeration called 'champion' is used to specify which annotation to keep (largest or smallest value) when an interaction occurs. For numeric annotations the text shall be placed such that the optical/geometric centre of the text represents the location.

For symbol annotations separate attributes from the coverage can be used to apply a scaling and rotation to the symbol. This can be useful for example when portraying a coverage that carries wave height and direction.

[[cls-9-11.1.13]]
==== Augmented Geometry

===== Overview

In case the required geometry for a drawing instruction is not explicitly given in a geographic dataset the portrayal function will generate this "augmented" geometry. A set of classes for such augmented geometries are part of the model. All positions used in this classes refer to a given coordinate reference system. Three types of CRS are supported:

. Geographic CRS
+
The coordinates are geographic coordinates.
. Portrayal CRS
+
The coordinate are referenced to the output device of the portrayal.
. Local CRS
+
--
The coordinates referring to a coordinate system with axes parallel to the Portrayal CRS but the origin shifted to the position of the referenced feature. Only point feature are supported for that type of CRS.
--

NOTE: The generated geometry only exists temporary for the purpose of portrayal and is not part of the dataset.

All types of augmented geometries can be used for the portrayal of text.

[[fig-9-13]]
.Point Feature with Augmented geometries
image::img98.png[]

More details can be found in the documentation of the drawing instruction model.

[[cls-9-11.2]]
=== Model of the Drawing Instruction Package

This package contains classes which describe the output of the portrayal functions. Display instructions link the feature types and their geometry to elements from the Symbol Elements package. <<fig-9-14>> below shows the model.

[[fig-9-14]]
.Drawing Instructions
image::img99.png[]

[yaml2text,sections/tables/11-tables.yaml,data]
----
{% for item in data %}
[[cls-9-11.2.{{forloop.index}}]]
==== {{item.table}}

{% assign first = item.rows[0] %}
{% assign has_extra = first.mult or first.type %}

.{{item.table}}
{% if has_extra %}
[cols="a,a,a,a,a",options="header"]
|===
| Role Name | Name | Description | Mult. | Type

{% for row in item.rows %}
| {{row.role_name}} | {{row.name}} | {{row.description}} | {{row.mult}} | {{row.type}}
{% endfor %}
|===
{% else %}
[cols="a,a,a",options="header"]
|===
| Role Name | Name | Description

{% for row in item.rows %}
| {{row.role_name}} | {{row.name}} | {{row.description}}
{% endfor %}
|===
{% endif %}

{% if item.note and item.note != "" %}
NOTE: {{item.note}}
{% endif %}

{% endfor %}
----
